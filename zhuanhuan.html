<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>MIDI 声部隔离解析器</title>
    <script src="midi.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 25px;
            background: #fdfdfd;
        }

        .box {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
        }

        textarea {
            width: 100%;
            height: 350px;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .bar {
            display: flex;
            gap: 12px;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        #run {
            background: #5865F2;
            color: white;
        }

        #dl {
            background: #23a559;
            color: white;
            display: none;
        }

        #log {
            font-size: 13px;
            color: #555;
            background: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
        }

        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
    </style>
</head>

<body>

    <div class="box">
        <h2>MIDI 精准声部隔离工具</h2>
        <p style="color: #666; font-size: 14px;">此版本通过物理 Track 隔离解决音符乱跳问题。导入 MuseScore 时，若出现多行，请直接全选其中一行并移动至钢琴大谱表即可。</p>

        <textarea id="ipt" placeholder="粘贴 JSON..."></textarea>

        <div class="bar">
            <input type="text" id="fn" value="isolated_voice_score">
            <button id="run">生成独立轨 MIDI</button>
            <button id="dl">保存文件</button>
        </div>

        <div id="log">等待数据...</div>
    </div>

    <script>
        const $ = e => document.querySelector(e);
        let midiOut = null;

        $('#run').onclick = () => {
            try {
                const data = JSON.parse($('#ipt').value);
                const midi = new Midi();
                midi.header.ppq = data.header.ppq;

                // 写入拍号和速度
                midi.header.timeSignatures = data.timeSignatures.map(ts => ({
                    ticks: ts.tick,
                    timeSignature: [ts.numerator, ts.denominator]
                }));
                midi.header.tempos = data.tempos.map(t => ({
                    ticks: t.tick,
                    bpm: t.bpm
                }));

                // 物理隔离：每个 JSON Track 对应一个 MIDI Track
                data.tracks.forEach((tData, i) => {
                    const track = midi.addTrack();
                    track.name = tData.name || `Track ${i + 1}`;
                    // 通道设为 0 (MIDI Channel 1)，防止 MuseScore 识别为不同乐器
                    track.channel = 0;

                    tData.notes.forEach(n => {
                        track.addNote({
                            midi: n.midi,
                            ticks: n.tick,
                            durationTicks: n.duration,
                            velocity: n.velocity / 127
                        });
                    });

                    if (tData.controlChanges) {
                        tData.controlChanges.forEach(cc => {
                            track.addCC({ number: cc.number, value: cc.value / 127, ticks: cc.tick });
                        });
                    }
                    const msg = `已生成物理音轨: ${track.name}，音符数: ${tData.notes.length}`;
                    const d = document.createElement('div'); d.innerText = msg; $('#log').appendChild(d);
                });

                midiOut = midi.toArray();
                $('#dl').style.display = 'block';
            } catch (e) { alert("JSON 错误: " + e.message); }
        };

        $('#dl').onclick = () => {
            const b = new Blob([midiOut], { type: 'audio/midi' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = $('#fn').value + '.mid';
            a.click();
        };
    </script>
</body>

</html>